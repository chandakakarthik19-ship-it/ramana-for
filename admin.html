<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f3f4f6;margin:0}
.container{max-width:1200px;margin:auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
h2,h3{color:#2563eb}
label{display:block;margin-top:10px;font-weight:bold}
input,select{width:100%;padding:8px;margin-top:5px}
button{margin-top:12px;padding:10px;border:none;border-radius:6px;background:#2563eb;color:#fff;font-weight:bold;cursor:pointer}
button.success{background:#16a34a}
button.warn{background:#f59e0b}
button.danger{background:#dc2626}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
.payment-row{background:#ecfeff}
.logout{text-align:center}
</style>
</head>

<body>
<div class="container">

<h2>Admin Dashboard</h2>

<!-- ================= ADD / EDIT WORK ================= -->
<div class="card">
<h3>Add / Edit Work</h3>

<label>Farmer</label>
<select id="farmerSelect"></select>

<label>Work Type</label>
<input list="workTypes" id="workType" placeholder="Enter work type">
<datalist id="workTypes">
  <option value="దుక్కు">
  <option value="లోడింగ్">
  <option value="రోటావేటర్">
  <option value="పంట కోత">
</datalist>

<label>Time (Minutes)</label>
<input type="number" id="minutes">

<label>Rate per Hour</label>
<input type="number" id="rate">

<button id="workBtn" onclick="addOrUpdateWork()">Add Work</button>
</div>

<!-- ================= HISTORY ================= -->
<div class="card">
<h3>History</h3>

<label>Select Farmer</label>
<select id="historyFarmer"></select>

<table>
<thead>
<tr>
  <th>Date</th>
  <th>Type</th>
  <th>Time</th>
  <th>Rate</th>
  <th>Total</th>
  <th>Paid</th>
  <th>Balance</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- ================= ADD PAYMENT ================= -->
<div class="card">
<h3>Add Payment</h3>

<label>Farmer</label>
<select id="payFarmer"></select>

<label>Amount</label>
<input type="number" id="payAmount">

<button class="success" onclick="addPayment()">Add Payment</button>
</div>

<!-- ================= CHANGE PASSWORD ================= -->
<div class="card">
<h3>Change Admin Password</h3>

<label>Old Password</label>
<input type="password" id="oldPass">

<label>New Password</label>
<input type="password" id="newPass">

<button class="warn" onclick="changePassword()">Change Password</button>
</div>

<div class="logout">
<button class="danger" onclick="logout()">Logout</button>
</div>

</div>

<script>
const API="https://ramana-back.onrender.com";
const token=()=>localStorage.getItem("token");
let editingWorkId=null;

document.addEventListener("DOMContentLoaded",loadFarmers);

/* ================= LOAD FARMERS ================= */
async function loadFarmers(){
  const res=await fetch(API+"/api/admin/farmers",{headers:{Authorization:"Bearer "+token()}});
  const data=await res.json();
  let opt='<option value="">-- Select Farmer --</option>';
  data.farmers.forEach(f=>opt+=`<option value="${f._id}">${f.name}</option>`);
  farmerSelect.innerHTML=historyFarmer.innerHTML=payFarmer.innerHTML=opt;
}

/* ================= ADD / UPDATE WORK ================= */
async function addOrUpdateWork(){
  if(!farmerSelect.value || !workType.value || !minutes.value || !rate.value){
    alert("Fill all fields");
    return;
  }

  const payload={
    farmerId:farmerSelect.value,
    workType:workType.value,
    minutes:+minutes.value,
    ratePer60:+rate.value
  };

  let url=API+"/api/admin/work";
  let method="POST";

  if(editingWorkId){
    url+="/"+editingWorkId;
    method="PUT";
  }

  await fetch(url,{
    method,
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token()
    },
    body:JSON.stringify(payload)
  });

  alert(editingWorkId?"Work Updated":"Work Added");

  editingWorkId=null;
  workBtn.innerText="Add Work";
  workType.value=minutes.value=rate.value="";

  historyFarmer.value=farmerSelect.value;
  historyFarmer.onchange();
}

/* ================= LOAD HISTORY ================= */
historyFarmer.onchange=async()=>{
  const res=await fetch(API+"/api/admin/work?farmerId="+historyFarmer.value,{
    headers:{Authorization:"Bearer "+token()}
  });
  const data=await res.json();
  tbody.innerHTML="";

  data.works.forEach(w=>{
    tbody.innerHTML+=`
      <tr data-id="${w._id}">
        <td>${new Date(w.date).toLocaleDateString()}</td>
        <td>${w.workType}</td>
        <td>${w.minutes}</td>
        <td>${w.ratePer60}</td>
        <td>${w.totalAmount}</td>
        <td>${w.paymentGiven}</td>
        <td>${w.totalAmount-w.paymentGiven}</td>
        <td>
          <button onclick="editWork('${w._id}','${w.farmer._id}','${w.workType}',${w.minutes},${w.ratePer60})">Edit</button>
          <button class="danger" onclick="deleteWork('${w._id}')">Delete</button>
        </td>
      </tr>
    `;
  });
};

/* ================= EDIT WORK ================= */
function editWork(id,farmerId,type,min,rate){
  editingWorkId=id;
  farmerSelect.value=farmerId;
  workType.value=type;
  minutes.value=min;
  rate.value=rate;
  workBtn.innerText="Update Work";
  window.scrollTo({top:0,behavior:"smooth"});
}

/* ================= ADD PAYMENT (NEW ROW) ================= */
async function addPayment(){
  if(!payFarmer.value || !payAmount.value){
    alert("Select farmer & amount");
    return;
  }

  await fetch(API+"/api/admin/payment/"+payFarmer.value,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token()
    },
    body:JSON.stringify({amount:+payAmount.value})
  });

  tbody.innerHTML+=`
    <tr class="payment-row">
      <td>${new Date().toLocaleDateString()}</td>
      <td>Payment</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>${payAmount.value}</td>
      <td>-</td>
      <td>-</td>
    </tr>
  `;

  payAmount.value="";
}

/* ================= DELETE WORK ================= */
async function deleteWork(id){
  await fetch(API+"/api/admin/work/"+id,{
    method:"DELETE",
    headers:{Authorization:"Bearer "+token()}
  });
  historyFarmer.onchange();
}

/* ================= CHANGE PASSWORD ================= */
async function changePassword(){
  await fetch(API+"/api/admin/change-password",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token()
    },
    body:JSON.stringify({
      oldPassword:oldPass.value,
      newPassword:newPass.value
    })
  });
  alert("Password Changed");
  oldPass.value=newPass.value="";
}

/* ================= LOGOUT ================= */
function logout(){
  localStorage.clear();
  location.href="index.html";
}
</script>

</body>
</html>
