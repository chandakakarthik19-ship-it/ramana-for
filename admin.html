<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --primary:#2563eb;
  --success:#16a34a;
  --warn:#f59e0b;
  --danger:#dc2626;
  --bg:#f3f4f6;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#6b7280;
}
body{font-family:Segoe UI,Arial;background:var(--bg);margin:0}
.container{max-width:1200px;margin:auto;padding:20px}
.card{
  background:var(--card);
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.06)
}
h2,h3{color:var(--primary);margin-top:0}
label{display:block;margin-top:10px;font-weight:600}
input,select{
  width:100%;
  padding:10px;
  margin-top:5px;
  border-radius:8px;
  border:1px solid var(--border)
}
button{
  margin-top:14px;
  padding:10px 18px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  color:#fff
}
.primary{background:var(--primary)}
.success{background:var(--success)}
.warn{background:var(--warn)}
.danger{background:var(--danger)}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid var(--border);padding:10px;text-align:center}
th{background:#f1f5f9}
.payment-row{background:#ecfeff}

/* SUMMARY */
.summary{display:flex;gap:20px;margin:15px 0}
.box{flex:1;background:#f9fafb;border:1px solid var(--border);border-radius:10px;padding:16px}
.box label{font-size:13px;color:var(--muted)}
.box div{font-size:22px;font-weight:700;margin-top:6px}
.total{color:var(--primary)}
.paid{color:var(--success)}
.balance{color:var(--danger)}
@media(max-width:768px){.summary{flex-direction:column}}
.logout{text-align:center}

/* TOAST */
.toast{
  position:fixed;bottom:30px;right:30px;
  background:#111827;color:#fff;
  padding:14px 20px;border-radius:10px;
  font-weight:600;opacity:0;
  transform:translateY(20px);
  transition:.4s ease;z-index:9999
}
.toast.show{opacity:1;transform:translateY(0)}
.toast.success{background:#16a34a}
.toast.warn{background:#f59e0b}
.toast.error{background:#dc2626}

/* CONFIRM MODAL */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.4);
  display:none;align-items:center;justify-content:center;
  z-index:9999
}
.modal.show{display:flex}
.modal-box{
  background:#fff;padding:25px;
  width:340px;border-radius:12px;
  text-align:center;box-shadow:0 20px 40px rgba(0,0,0,.25)
}
.modal-box h3{margin-top:0;color:#dc2626}
.modal-actions{display:flex;gap:10px;margin-top:20px}
.modal-actions button{flex:1}
</style>
</head>

<body>
<div class="container">
<h2>Admin Dashboard</h2>

<!-- ADD / EDIT WORK -->
<div class="card">
<h3>Add / Edit Work</h3>

<label>Farmer</label>
<select id="farmerSelect"></select>

<label>Work Type</label>
<select id="workType">
  <option value="">-- Select --</option>
  <option>దుక్కు</option>
  <option>లోడింగ్</option>
  <option>రోటావేటర్</option>
  <option>జొన్నలు</option>
  <option>వరిసేను ఆట</option>
  <option>గత్తం</option>
</select>

<label>Time (Minutes)</label>
<input type="number" id="minutes">

<label>Rate per Hour</label>
<input type="number" id="rate">

<button id="workBtn" class="primary" onclick="addOrUpdateWork()">Add Work</button>
</div>

<!-- HISTORY -->
<div class="card">
<h3>History</h3>
<label>Select Farmer</label>
<select id="historyFarmer"></select>

<div class="summary">
  <div class="box"><label>Total</label><div class="total" id="adminTotal">₹0</div></div>
  <div class="box"><label>Paid</label><div class="paid" id="adminPaid">₹0</div></div>
  <div class="box"><label>Balance</label><div class="balance" id="adminBalance">₹0</div></div>
</div>

<table>
<thead>
<tr>
<th>Date</th><th>Type</th><th>Min</th><th>Rate</th>
<th>Total</th><th>Paid</th><th>Balance</th><th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- PAYMENT -->
<div class="card">
<h3>Add Payment</h3>
<label>Farmer</label>
<select id="payFarmer"></select>
<label>Amount</label>
<input type="number" id="payAmount">
<button class="success" onclick="addPayment()">Add Payment</button>
</div>

<!-- MANAGE FARMER -->
<div class="card">
<h3>Manage Farmer</h3>
<label>Farmer</label>
<select id="deleteFarmerSelect"></select>
<label>Admin Password</label>
<input type="password" id="confirmAdminPass">
<button class="danger" onclick="deleteFarmer()">Delete Farmer</button>
</div>

<!-- CHANGE PASSWORD -->
<div class="card">
<h3>Change Admin Password</h3>
<label>Old Password</label>
<input type="password" id="oldPass">
<label>New Password</label>
<input type="password" id="newPass">
<button class="warn" onclick="changePassword()">Change Password</button>
</div>

<div class="logout">
<button class="danger" onclick="logout()">Logout</button>
</div>
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- CONFIRM MODAL -->
<div id="confirmModal" class="modal">
  <div class="modal-box">
    <h3 id="confirmTitle">Confirm</h3>
    <p id="confirmMessage"></p>
    <div class="modal-actions">
      <button class="warn" id="confirmYes">OK</button>
      <button class="danger" onclick="closeConfirm()">Cancel</button>
    </div>
  </div>
</div>

<script>
const API="https://ramana-back.onrender.com";
const token=()=>localStorage.getItem("token");
let editingWorkId=null, confirmCallback=null;

/* TOAST */
function showToast(msg,type="success"){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.className="toast show "+type;
  setTimeout(()=>t.classList.remove("show"),3000);
}

/* CONFIRM */
function openConfirm(title,msg,cb){
  confirmTitle.innerText=title;
  confirmMessage.innerText=msg;
  confirmCallback=cb;
  confirmModal.classList.add("show");
}
function closeConfirm(){
  confirmModal.classList.remove("show");
  confirmCallback=null;
}
confirmYes.onclick=()=>{ if(confirmCallback) confirmCallback(); closeConfirm(); };

document.addEventListener("DOMContentLoaded",loadFarmers);

/* LOAD FARMERS */
async function loadFarmers(){
  const r=await fetch(API+"/api/admin/farmers",{headers:{Authorization:"Bearer "+token()}});
  const d=await r.json(); if(!d.success) return;
  let o='<option value="">-- Select --</option>';
  d.farmers.forEach(f=>o+=`<option value="${f._id}">${f.name}</option>`);
  farmerSelect.innerHTML=historyFarmer.innerHTML=payFarmer.innerHTML=deleteFarmerSelect.innerHTML=o;
}

/* ADD / UPDATE WORK */
async function addOrUpdateWork(){
  if(!farmerSelect.value||!workType.value||!minutes.value||!rate.value)
    return showToast("Fill all fields","error");

  let url=API+"/api/work/add",method="POST";
  let body={workType:workType.value,minutes:+minutes.value,ratePer60:+rate.value};

  if(editingWorkId){url=API+"/api/work/"+editingWorkId;method="PUT";}
  else body.farmerId=farmerSelect.value;

  await fetch(url,{method,headers:{
    "Content-Type":"application/json",Authorization:"Bearer "+token()
  },body:JSON.stringify(body)});

  showToast(editingWorkId?"Work updated":"Work added");
  editingWorkId=null; workBtn.innerText="Add Work";
  workType.value=minutes.value=rate.value="";
  historyFarmer.value=farmerSelect.value;
  loadHistory();
}

/* HISTORY */
async function loadHistory(){
  if(!historyFarmer.value) return;
  tbody.innerHTML=""; let total=0,paid=0;

  const w=await fetch(API+"/api/admin/work?farmerId="+historyFarmer.value,
    {headers:{Authorization:"Bearer "+token()}});
  const wd=await w.json();

  wd.works.forEach(x=>{
    total+=x.totalAmount;
    tbody.innerHTML+=`
<tr>
<td>${new Date(x.date).toLocaleDateString()}</td>
<td>${x.workType}</td>
<td>${x.minutes}</td>
<td>${x.ratePer60}</td>
<td>${x.totalAmount}</td>
<td>${x.paymentGiven||0}</td>
<td>${x.totalAmount-(x.paymentGiven||0)}</td>
<td>
<button class="primary" onclick="editWork('${x._id}','${x.farmer._id}','${x.workType}',${x.minutes},${x.ratePer60})">Edit</button>
<button class="danger" onclick="confirmDeleteWork('${x._id}')">Delete</button>
</td></tr>`;
  });

  const fr=await fetch(API+"/api/admin/farmers",{headers:{Authorization:"Bearer "+token()}});
  const fd=await fr.json();
  const f=fd.farmers.find(x=>x._id===historyFarmer.value);
  if(f) f.payments.forEach(p=>{
    paid+=p.amount;
    tbody.innerHTML+=`
<tr class="payment-row">
<td>${new Date(p.date).toLocaleDateString()}</td>
<td>Payment</td><td>-</td><td>-</td><td>-</td>
<td>${p.amount}</td><td>-</td>
<td><button class="danger" onclick="confirmDeletePayment('${f._id}','${p._id}')">Delete</button></td>
</tr>`;
  });

  adminTotal.innerText="₹"+total;
  adminPaid.innerText="₹"+paid;
  adminBalance.innerText="₹"+(total-paid);
}
historyFarmer.onchange=loadHistory;

/* EDIT */
function editWork(id,fid,type,min,rate){
  editingWorkId=id;
  farmerSelect.value=fid;
  workType.value=type;
  minutes.value=min;
  rate.value=rate;
  workBtn.innerText="Update Work";
  window.scrollTo({top:0,behavior:"smooth"});
}

/* CONFIRM ACTIONS */
function confirmDeleteWork(id){
  openConfirm("Delete Work","Are you sure you want to delete this work?",async()=>{
    await fetch(API+"/api/work/"+id,{method:"DELETE",headers:{Authorization:"Bearer "+token()}});
    showToast("Work deleted","warn"); loadHistory();
  });
}
function confirmDeletePayment(fid,pid){
  openConfirm("Delete Payment","Delete this payment permanently?",async()=>{
    await fetch(API+"/api/admin/payment/"+fid+"/"+pid,{method:"DELETE",headers:{Authorization:"Bearer "+token()}});
    showToast("Payment deleted","warn"); loadHistory();
  });
}

/* PAYMENT */
async function addPayment(){
  if(!payFarmer.value||!payAmount.value)
    return showToast("Fill fields","error");
  await fetch(API+"/api/admin/payment/"+payFarmer.value,{
    method:"POST",headers:{
      "Content-Type":"application/json",Authorization:"Bearer "+token()
    },body:JSON.stringify({amount:+payAmount.value})
  });
  showToast("Payment added");
  payAmount.value="";
  historyFarmer.value=payFarmer.value;
  loadHistory();
}

/* DELETE FARMER */
function deleteFarmer(){
  if(!deleteFarmerSelect.value||!confirmAdminPass.value)
    return showToast("Enter admin password","error");
  openConfirm("Delete Farmer","All data will be deleted. Continue?",async()=>{
    await fetch(API+"/api/admin/farmers/"+deleteFarmerSelect.value,{method:"DELETE",
      headers:{Authorization:"Bearer "+token()}});
    showToast("Farmer deleted","warn");
    confirmAdminPass.value=""; loadFarmers();
  });
}

/* CHANGE PASSWORD */
function changePassword(){
  if(!oldPass.value||!newPass.value)
    return showToast("Fill all fields","error");
  openConfirm("Change Password","Change admin password?",async()=>{
    await fetch(API+"/api/admin/change-password",{method:"POST",
      headers:{"Content-Type":"application/json",Authorization:"Bearer "+token()},
      body:JSON.stringify({oldPassword:oldPass.value,newPassword:newPass.value})
    });
    showToast("Password changed");
    oldPass.value=newPass.value="";
  });
}

/* LOGOUT */
function logout(){localStorage.clear();location.href="index.html";}
</script>
</body>
</html>
