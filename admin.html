<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<style>
body{font-family:Segoe UI;background:#f3f4f6;margin:0}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:#fff;border-radius:10px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
h2,h3{color:#2563eb;margin-top:0}
label{display:block;margin-top:12px;font-weight:600}
input,select{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ddd}
button{margin-top:14px;padding:10px 16px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
button.danger{background:#dc2626}
button.success{background:#16a34a}
.logout{text-align:center}
</style>
</head>

<body>
<div class="container">
<h2>Admin Dashboard</h2>

<!-- ================= CHANGE PASSWORD ================= -->
<div class="card">
<h3>Change Admin Password</h3>

<label>Old Password</label>
<input type="password" id="oldPass">

<label>New Password</label>
<input type="password" id="newPass">

<button onclick="changePassword()">Change Password</button>
</div>

<!-- ================= MANAGE FARMER ================= -->
<div class="card">
<h3>Manage Farmer</h3>

<label>Select Farmer</label>
<select id="deleteFarmer"></select>

<button class="danger" onclick="deleteFarmer()">Delete Farmer</button>
</div>

<!-- ================= ADD PAYMENT ================= -->
<div class="card">
<h3>Add Payment</h3>

<label>Select Farmer</label>
<select id="payFarmer"></select>

<label>Payment Amount</label>
<input type="number" id="payAmount">

<button class="success" onclick="addPayment()">Add Payment</button>
</div>

<!-- ================= WORK HISTORY ================= -->
<div class="card">
<h3>Farmer Work History</h3>

<select id="historyFarmer"></select>

<table width="100%" border="1" cellspacing="0" cellpadding="8">
<thead>
<tr>
<th>Date</th>
<th>Work</th>
<th>Total</th>
<th>Paid</th>
<th>Balance</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="logout">
<button class="danger" onclick="logout()">Logout</button>
</div>

</div>

<script>
const API="https://ramana-back.onrender.com";
const token=()=>localStorage.getItem("token");

window.onload=loadFarmers;

/* LOAD FARMERS */
async function loadFarmers(){
const res=await fetch(API+"/api/admin/farmers",{headers:{Authorization:"Bearer "+token()}});
const data=await res.json();
const list=data.farmers||[];
const opts=list.map(f=>`<option value="${f._id}">${f.name}</option>`).join("");
deleteFarmer.innerHTML=payFarmer.innerHTML=historyFarmer.innerHTML="<option value=''>Select</option>"+opts;
}

/* CHANGE PASSWORD */
async function changePassword(){
await fetch(API+"/api/admin/change-password",{
method:"POST",
headers:{
"Content-Type":"application/json",
Authorization:"Bearer "+token()
},
body:JSON.stringify({
oldPassword:oldPass.value,
newPassword:newPass.value
})
});
alert("Password changed");
oldPass.value=newPass.value="";
}

/* DELETE FARMER */
async function deleteFarmer(){
if(!confirm("Delete Farmer?"))return;
await fetch(API+"/api/admin/farmer/"+deleteFarmer.value,{
method:"DELETE",
headers:{Authorization:"Bearer "+token()}
});
alert("Farmer Deleted");
loadFarmers();
}

/* ADD PAYMENT */
async function addPayment(){
await fetch(API+"/api/admin/payment/"+payFarmer.value,{
method:"POST",
headers:{
"Content-Type":"application/json",
Authorization:"Bearer "+token()
},
body:JSON.stringify({amount:Number(payAmount.value)})
});
alert("Payment Added");
payAmount.value="";
}

/* LOAD HISTORY */
historyFarmer.onchange=async()=>{
const res=await fetch(API+"/api/admin/work?farmerId="+historyFarmer.value,{
headers:{Authorization:"Bearer "+token()}
});
const data=await res.json();
tbody.innerHTML="";
data.works.forEach(w=>{
tbody.innerHTML+=`
<tr>
<td>${new Date(w.date).toLocaleDateString()}</td>
<td>${w.workType}</td>
<td>${w.totalAmount}</td>
<td>${w.paymentGiven}</td>
<td>${w.totalAmount-w.paymentGiven}</td>
<td><button onclick="deleteWork('${w._id}')">X</button></td>
</tr>`;
});
}

/* DELETE WORK */
async function deleteWork(id){
await fetch(API+"/api/admin/work/"+id,{
method:"DELETE",
headers:{Authorization:"Bearer "+token()}
});
historyFarmer.onchange();
}

/* LOGOUT */
function logout(){
localStorage.clear();
location.href="index.html";
}
</script>
</body>
</html>
