<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f3f4f6;margin:0}
.container{max-width:1100px;margin:auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
h2,h3{color:#2563eb;margin-top:0}
label{display:block;margin-top:10px;font-weight:bold}
input,select{width:100%;padding:8px;margin-top:5px}
button{margin-top:12px;padding:10px;border:none;border-radius:6px;background:#2563eb;color:#fff;font-weight:bold;cursor:pointer}
button.danger{background:#dc2626}
button.success{background:#16a34a}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
.summary{display:flex;gap:20px;margin-top:15px}
.summary div{flex:1}
.logout{text-align:center}
</style>
</head>

<body>
<div class="container">

<h2>Admin Dashboard</h2>

<!-- ================= ADD WORK ================= -->
<div class="card">
<h3>Add Work</h3>

<label>Farmer</label>
<select id="farmerSelect"></select>

<label>Work Type</label>
<select id="workType">
  <option value="">-- Select Work --</option>
  <option>దుక్కు</option>
  <option>లోడింగ్</option>
  <option>రోటావేటర్</option>
  <option>వరిసేను</option>
</select>

<label>Time Worked (Minutes)</label>
<input type="number" id="minutes">

<label>Rate Per Hour</label>
<input type="number" id="rate">

<button onclick="addWork()">Add Work</button>
</div>

<!-- ================= WORK HISTORY ================= -->
<div class="card">
<h3>Work History</h3>

<label>Select Farmer</label>
<select id="historyFarmer"></select>

<table>
<thead>
<tr>
  <th>Date</th>
  <th>Work</th>
  <th>Time (min)</th>
  <th>Rate/hr</th>
  <th>Total</th>
  <th>Paid</th>
  <th>Balance</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div class="summary">
  <div>
    <label>Total</label>
    <input id="totalBox" readonly>
  </div>
  <div>
    <label>Paid</label>
    <input id="paidBox" readonly>
  </div>
  <div>
    <label>Balance</label>
    <input id="balanceBox" readonly>
  </div>
</div>
</div>

<!-- ================= ADD PAYMENT ================= -->
<div class="card">
<h3>Add Payment</h3>

<label>Farmer</label>
<select id="payFarmer"></select>

<label>Amount</label>
<input type="number" id="payAmount">

<button class="success" onclick="addPayment()">Add Payment</button>
</div>

<!-- ================= MANAGE FARMER ================= -->
<div class="card">
<h3>Manage Farmer</h3>

<label>Select Farmer</label>
<select id="deleteFarmer"></select>

<button class="danger" onclick="deleteFarmer()">Delete Farmer</button>
</div>

<div class="logout">
<button class="danger" onclick="logout()">Logout</button>
</div>

</div>

<script>
const API = "https://ramana-back.onrender.com";
const token = () => localStorage.getItem("token");

document.addEventListener("DOMContentLoaded", loadFarmers);

/* ================= LOAD FARMERS ================= */
async function loadFarmers(){
  const res = await fetch(API + "/api/admin/farmers",{
    headers:{ Authorization:"Bearer " + token() }
  });
  const data = await res.json();
  const farmers = data.farmers || [];

  let options = `<option value="">-- Select Farmer --</option>`;
  farmers.forEach(f=>{
    options += `<option value="${f._id}">${f.name}</option>`;
  });

  farmerSelect.innerHTML = options;
  historyFarmer.innerHTML = options;
  payFarmer.innerHTML = options;
  deleteFarmer.innerHTML = options;
}

/* ================= ADD WORK ================= */
async function addWork(){
  if(!farmerSelect.value || !workType.value || !minutes.value || !rate.value){
    alert("Fill all fields");
    return;
  }

  await fetch(API + "/api/admin/work",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer " + token()
    },
    body:JSON.stringify({
      farmerId: farmerSelect.value,
      workType: workType.value,
      minutes: Number(minutes.value),
      ratePer60: Number(rate.value)
    })
  });

  alert("Work Added");
  minutes.value = rate.value = "";

  historyFarmer.value = farmerSelect.value;
  historyFarmer.onchange();
}

/* ================= LOAD HISTORY ================= */
historyFarmer.onchange = async ()=>{
  const res = await fetch(API + "/api/admin/work?farmerId=" + historyFarmer.value,{
    headers:{ Authorization:"Bearer " + token() }
  });
  const data = await res.json();

  let total = 0, paid = 0;
  tbody.innerHTML = "";

  data.works.forEach(w=>{
    total += w.totalAmount;
    paid += w.paymentGiven;

    tbody.innerHTML += `
      <tr data-id="${w._id}">
        <td>${new Date(w.date).toLocaleDateString()}</td>
        <td>${w.workType}</td>
        <td>${w.minutes}</td>
        <td>${w.ratePer60}</td>
        <td>${w.totalAmount}</td>
        <td>${w.paymentGiven}</td>
        <td>${w.totalAmount - w.paymentGiven}</td>
        <td><button onclick="deleteWork('${w._id}')">Delete</button></td>
      </tr>
    `;
  });

  totalBox.value = total;
  paidBox.value = paid;
  balanceBox.value = total - paid;
};

/* ================= ADD PAYMENT ================= */
async function addPayment(){
  if(!payFarmer.value || !payAmount.value){
    alert("Select farmer and enter amount");
    return;
  }

  if(historyFarmer.value !== payFarmer.value){
    alert("Select same farmer in Work History");
    return;
  }

  const lastRow = tbody.querySelector("tr:last-child");
  if(!lastRow){
    alert("No work found");
    return;
  }

  const workId = lastRow.getAttribute("data-id");

  await fetch(API + "/api/admin/payment/" + payFarmer.value,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer " + token()
    },
    body:JSON.stringify({
      amount:Number(payAmount.value),
      workId
    })
  });

  alert("Payment Added");
  payAmount.value="";
  historyFarmer.onchange();
}

/* ================= DELETE WORK ================= */
async function deleteWork(id){
  await fetch(API + "/api/admin/work/" + id,{
    method:"DELETE",
    headers:{ Authorization:"Bearer " + token() }
  });
  historyFarmer.onchange();
}

/* ================= DELETE FARMER ================= */
async function deleteFarmer(){
  if(!confirm("Delete Farmer?")) return;
  await fetch(API + "/api/admin/farmer/" + deleteFarmer.value,{
    method:"DELETE",
    headers:{ Authorization:"Bearer " + token() }
  });
  alert("Farmer Deleted");
  loadFarmers();
}

/* ================= LOGOUT ================= */
function logout(){
  localStorage.clear();
  location.href = "index.html";
}
</script>

</body>
</html>
