<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --primary:#2563eb;
  --success:#16a34a;
  --warn:#f59e0b;
  --danger:#dc2626;
  --bg:#f3f4f6;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#6b7280;
}
body{
  font-family:Segoe UI,Arial;
  background:var(--bg);
  margin:0;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}
.card{
  background:var(--card);
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.06);
}
h2,h3{color:var(--primary);margin-top:0}
label{display:block;margin-top:10px;font-weight:600}
input,select{
  width:100%;
  padding:10px;
  margin-top:5px;
  border-radius:8px;
  border:1px solid var(--border);
}
button{
  margin-top:14px;
  padding:10px 18px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  color:#fff;
}
.primary{background:var(--primary)}
.success{background:var(--success)}
.warn{background:var(--warn)}
.danger{background:var(--danger)}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  border:1px solid var(--border);
  padding:10px;
  text-align:center;
}
th{background:#f1f5f9}
.payment-row{background:#ecfeff}

/* ===== SUMMARY BOXES ===== */
.summary{
  display:flex;
  gap:20px;
  margin:15px 0;
}
.box{
  flex:1;
  background:#f9fafb;
  border:1px solid var(--border);
  border-radius:10px;
  padding:16px;
}
.box label{font-size:13px;color:var(--muted)}
.box div{font-size:22px;font-weight:700;margin-top:6px}
.total{color:var(--primary)}
.paid{color:var(--success)}
.balance{color:var(--danger)}
@media(max-width:768px){.summary{flex-direction:column}}
.logout{text-align:center}
</style>
</head>

<body>
<div class="container">

<h2>Admin Dashboard</h2>

<!-- ================= ADD / EDIT WORK ================= -->
<div class="card">
<h3>Add / Edit Work</h3>

<label>Farmer</label>
<select id="farmerSelect"></select>

<label>Work Type</label>
<select id="workType">
  <option value="">-- Select --</option>
  <option>దుక్కు</option>
  <option>లోడింగ్</option>
  <option>రోటావేటర్</option>
  <option>జొన్నలు</option>
  <option>వరిసేను ఆట</option>
  <option>గత్తం</option>
</select>

<label>Time (Minutes)</label>
<input type="number" id="minutes">

<label>Rate per Hour</label>
<input type="number" id="rate">

<button id="workBtn" class="primary" onclick="addOrUpdateWork()">Add Work</button>
</div>

<!-- ================= HISTORY ================= -->
<div class="card">
<h3>History (Work + Payments)</h3>

<label>Select Farmer</label>
<select id="historyFarmer"></select>

<!-- SUMMARY BOXES -->
<div class="summary">
  <div class="box">
    <label>Total Amount</label>
    <div class="total" id="adminTotal">₹0</div>
  </div>
  <div class="box">
    <label>Total Paid</label>
    <div class="paid" id="adminPaid">₹0</div>
  </div>
  <div class="box">
    <label>Balance</label>
    <div class="balance" id="adminBalance">₹0</div>
  </div>
</div>

<table>
<thead>
<tr>
  <th>Date</th>
  <th>Type</th>
  <th>Minutes</th>
  <th>Rate</th>
  <th>Total</th>
  <th>Paid</th>
  <th>Balance</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- ================= PAYMENT ================= -->
<div class="card">
<h3>Add Payment</h3>

<label>Select Farmer</label>
<select id="payFarmer"></select>

<label>Amount</label>
<input type="number" id="payAmount">

<button class="success" onclick="addPayment()">Add Payment</button>
</div>

<!-- ================= MANAGE FARMER ================= -->
<div class="card">
<h3>Manage Farmer</h3>

<label>Select Farmer</label>
<select id="deleteFarmerSelect"></select>

<label>Admin Password</label>
<input type="password" id="confirmAdminPass">

<button class="danger" onclick="deleteFarmer()">Delete Farmer</button>
</div>

<!-- ================= CHANGE PASSWORD ================= -->
<div class="card">
<h3>Change Admin Password</h3>

<label>Old Password</label>
<input type="password" id="oldPass">

<label>New Password</label>
<input type="password" id="newPass">

<button class="warn" onclick="changePassword()">Change Password</button>
</div>

<div class="logout">
<button class="danger" onclick="logout()">Logout</button>
</div>

</div>

<script>
const API = "https://ramana-back.onrender.com";
const token = () => localStorage.getItem("token");
let editingWorkId = null;

document.addEventListener("DOMContentLoaded", loadFarmers);

/* ================= LOAD FARMERS ================= */
async function loadFarmers(){
  const res = await fetch(API + "/api/admin/farmers",{
    headers:{ Authorization:"Bearer " + token() }
  });
  const data = await res.json();
  if(!data.success) return;

  let opt = '<option value="">-- Select Farmer --</option>';
  data.farmers.forEach(f=>{
    opt += `<option value="${f._id}">${f.name}</option>`;
  });

  farmerSelect.innerHTML = opt;
  historyFarmer.innerHTML = opt;
  payFarmer.innerHTML = opt;
  deleteFarmerSelect.innerHTML = opt;
}

/* ================= ADD / UPDATE WORK ================= */
async function addOrUpdateWork(){
  if(!farmerSelect.value || !workType.value || !minutes.value || !rate.value){
    alert("Fill all fields");
    return;
  }

  const payload = {
    farmerId: farmerSelect.value,
    workType: workType.value,
    minutes:Number(minutes.value),
    ratePer60:Number(rate.value)
  };

  await fetch(API + "/api/work/add",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer " + token()
    },
    body:JSON.stringify(payload)
  });

  workType.value = minutes.value = rate.value = "";
  historyFarmer.value = farmerSelect.value;
  loadHistory();
}

/* ================= LOAD HISTORY + SUMMARY ================= */
async function loadHistory(){
  if(!historyFarmer.value) return;
  tbody.innerHTML = "";

  let total = 0;
  let paid  = 0;

  const workRes = await fetch(
    API + "/api/admin/work?farmerId=" + historyFarmer.value,
    { headers:{ Authorization:"Bearer " + token() } }
  );
  const workData = await workRes.json();

  workData.works.forEach(w=>{
    total += w.totalAmount || 0;
    tbody.innerHTML += `
      <tr>
        <td>${new Date(w.date).toLocaleDateString()}</td>
        <td>${w.workType}</td>
        <td>${w.minutes}</td>
        <td>${w.ratePer60}</td>
        <td>${w.totalAmount}</td>
        <td>${w.paymentGiven || 0}</td>
        <td>${w.totalAmount - (w.paymentGiven||0)}</td>
        <td>
          <button class="danger" onclick="deleteWork('${w._id}')">Delete</button>
        </td>
      </tr>`;
  });

  const farmerRes = await fetch(API + "/api/admin/farmers",{
    headers:{ Authorization:"Bearer " + token() }
  });
  const farmerData = await farmerRes.json();
  const farmer = farmerData.farmers.find(f=>f._id===historyFarmer.value);

  if(farmer){
    farmer.payments.forEach(p=>{
      paid += p.amount || 0;
      tbody.innerHTML += `
        <tr class="payment-row">
          <td>${new Date(p.date).toLocaleDateString()}</td>
          <td>Payment</td>
          <td>-</td><td>-</td><td>-</td>
          <td>${p.amount}</td>
          <td>-</td>
          <td>
            <button class="danger" onclick="deletePayment('${farmer._id}','${p._id}')">Delete</button>
          </td>
        </tr>`;
    });
  }

  adminTotal.innerText = "₹" + total;
  adminPaid.innerText  = "₹" + paid;
  adminBalance.innerText = "₹" + (total - paid);
}

historyFarmer.onchange = loadHistory;

/* ================= ADD PAYMENT ================= */
async function addPayment(){
  if(!payFarmer.value || !payAmount.value) return alert("Fill fields");
  await fetch(API + "/api/admin/payment/" + payFarmer.value,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer " + token()
    },
    body:JSON.stringify({ amount:Number(payAmount.value) })
  });
  payAmount.value="";
  historyFarmer.value = payFarmer.value;
  loadHistory();
}

/* ================= DELETE WORK ================= */
async function deleteWork(id){
  if(!confirm("Delete work?")) return;
  await fetch(API + "/api/work/" + id,{
    method:"DELETE",
    headers:{ Authorization:"Bearer " + token() }
  });
  loadHistory();
}

/* ================= DELETE PAYMENT ================= */
async function deletePayment(fid,pid){
  if(!confirm("Delete payment?")) return;
  await fetch(API + "/api/admin/payment/"+fid+"/"+pid,{
    method:"DELETE",
    headers:{ Authorization:"Bearer " + token() }
  });
  loadHistory();
}

/* ================= DELETE FARMER ================= */
async function deleteFarmer(){
  if(!deleteFarmerSelect.value || !confirmAdminPass.value){
    alert("Select farmer & enter password");
    return;
  }
  await fetch(API + "/api/admin/farmers/"+deleteFarmerSelect.value,{
    method:"DELETE",
    headers:{ Authorization:"Bearer " + token() }
  });
  confirmAdminPass.value="";
  loadFarmers();
}

/* ================= CHANGE PASSWORD ================= */
async function changePassword(){
  await fetch(API + "/api/admin/change-password",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer " + token()
    },
    body:JSON.stringify({
      oldPassword:oldPass.value,
      newPassword:newPass.value
    })
  });
  oldPass.value=newPass.value="";
  alert("Password changed");
}

/* ================= LOGOUT ================= */
function logout(){
  localStorage.clear();
  location.href="index.html";
}
</script>

</body>
</html>
