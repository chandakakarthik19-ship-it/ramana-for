<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Farmer Dashboard</title>

<style>
:root{
  --primary:#2563eb;
  --success:#16a34a;
  --danger:#dc2626;
  --bg:#f3f4f6;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}
h1{color:var(--primary)}
.card{
  background:var(--card);
  border-radius:12px;
  padding:25px;
  box-shadow:0 10px 25px rgba(0,0,0,.06);
}
.info{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:15px;
}
.actions a{
  text-decoration:none;
  font-weight:600;
  padding:8px 14px;
  border-radius:8px;
  color:white;
  background:var(--primary);
  margin-left:8px;
}
.logout{background:var(--danger)}
.summary{
  display:flex;
  gap:20px;
  margin:20px 0;
}
.box{
  flex:1;
  background:#f9fafb;
  border:1px solid var(--border);
  border-radius:10px;
  padding:18px;
}
.box label{font-size:13px;color:var(--muted)}
.box div{font-size:22px;font-weight:700}
.total{color:var(--primary)}
.paid{color:var(--success)}
.balance{color:var(--danger)}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  border:1px solid var(--border);
  padding:10px;
  font-size:14px;
}
th{background:#f1f5f9}
.empty{text-align:center;color:var(--muted)}
@media(max-width:768px){
  .summary{flex-direction:column}
}
</style>
</head>

<body>
<div class="container">

<h1>Farmer Dashboard</h1>

<div class="card">
  <div class="info" id="info"></div>

  <div class="summary">
    <div class="box">
      <label>మొత్తం</label>
      <div class="total" id="totalBox">₹0</div>
    </div>
    <div class="box">
      <label>చెల్లించిన మొత్తం</label>
      <div class="paid" id="paidBox">₹0</div>
    </div>
    <div class="box">
      <label>బాకీ</label>
      <div class="balance" id="balanceBox">₹0</div>
    </div>
  </div>

  <h3>పని & చెల్లింపు వివరాలు</h3>

  <table>
    <thead>
      <tr>
        <th>తేదీ</th>
        <th>రకం</th>
        <th>నిమిషాలు</th>
        <th>రేట్</th>
        <th>మొత్తం</th>
        <th>చెల్లింపు</th>
        <th>గమనిక</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

</div>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
const API="https://ramana-back.onrender.com";

async function loadDashboard(){
  const token=localStorage.getItem("token");
  const name=localStorage.getItem("name");

  if(!token){
    location.href="farmer-login.html";
    return;
  }

  document.getElementById("info").innerHTML=`
    <div>
      <strong>${name||"Farmer"}</strong><br>
      <span>Role: Farmer</span>
    </div>
    <div class="actions">
      <a href="#" onclick="downloadPDF()">Download PDF</a>
      <a class="logout" href="#" onclick="logout()">Logout</a>
    </div>
  `;

  const res=await fetch(API+"/api/farmer/dashboard",{
    headers:{Authorization:"Bearer "+token}
  });

  const data=await res.json();
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  let total=0,paid=0;

  data.works.forEach(w=>{
    total+=w.totalAmount||0;
    tbody.innerHTML+=`
      <tr>
        <td>${new Date(w.date).toLocaleDateString()}</td>
        <td>${w.workType}</td>
        <td>${w.minutes}</td>
        <td>₹${w.ratePer60}</td>
        <td>₹${w.totalAmount}</td>
        <td>₹${w.paymentGiven||0}</td>
        <td>-</td>
      </tr>`;
  });

  data.farmer.payments.forEach(p=>{
    paid+=p.amount||0;
    tbody.innerHTML+=`
      <tr>
        <td>${new Date(p.date).toLocaleDateString()}</td>
        <td>Payment</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-₹${p.amount}</td>
        <td>-</td>
      </tr>`;
  });

  if(!tbody.innerHTML){
    tbody.innerHTML=`<tr><td colspan="7" class="empty">No records</td></tr>`;
  }

  totalBox.innerText="₹"+total;
  paidBox.innerText="₹"+paid;
  balanceBox.innerText="₹"+(total-paid);
}

async function downloadPDF(){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();

  const font=await fetch("NotoTelugu-Regular.ttf").then(r=>r.arrayBuffer());
  doc.addFileToVFS("NotoTelugu.ttf",font);
  doc.addFont("NotoTelugu.ttf","NotoTelugu","normal");
  doc.setFont("NotoTelugu");

  doc.setFontSize(16);
  doc.text("రైతు పని & చెల్లింపుల వివరాలు",14,15);

  const rows=[];
  document.querySelectorAll("#tbody tr").forEach(tr=>{
    rows.push([...tr.children].map(td=>td.innerText));
  });

  doc.autoTable({
    startY:25,
    head:[["తేదీ","రకం","నిమిషాలు","రేట్","మొత్తం","చెల్లింపు","గమనిక"]],
    body:rows,
    styles:{font:"NotoTelugu",fontSize:10}
  });

  let y=doc.lastAutoTable.finalY+10;
  doc.text("మొత్తం : "+totalBox.innerText,14,y);
  doc.text("చెల్లించిన మొత్తం : "+paidBox.innerText,14,y+8);
  doc.text("బాకీ : "+balanceBox.innerText,14,y+16);

  doc.save("Farmer_Report_Telugu.pdf");
}

function logout(){
  localStorage.clear();
  location.href="farmer-login.html";
}

loadDashboard();
</script>
</body>
</html>
